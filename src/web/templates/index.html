{% extends "base.html" %}

{% block title %}AI Web CTF Solver - Home{% endblock %}

{% block content %}
<div class="row">
    <!-- Hero Section -->
    <div class="col-12 mb-5">
        <div class="card bg-gradient-primary text-white card-hover">
            <div class="card-body p-5 text-center">
                <h1 class="display-4 fw-bold mb-3">
                    <i class="fas fa-shield-alt me-3"></i>AI Web CTF Solver
                </h1>
                <p class="lead mb-4">
                    Automated web CTF challenge solving using LangGraph multi-agent AI system
                </p>
                <div class="row text-center">
                    <div class="col-md-3">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <h6>Intelligent Crawling</h6>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-brain fa-2x mb-2"></i>
                        <h6>AI Analysis</h6>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-crosshairs fa-2x mb-2"></i>
                        <h6>Threat Modeling</h6>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-bolt fa-2x mb-2"></i>
                        <h6>Smart Exploitation</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Challenge Submission Form -->
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-flag me-2"></i>Submit CTF Challenge</h4>
            </div>
            <div class="card-body">
                <form id="challenge-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="url" class="form-label">Challenge URL *</label>
                            <input type="url" class="form-control" id="url" name="url" required
                                   placeholder="https://ctf.example.com/challenge">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">Challenge Title</label>
                            <input type="text" class="form-control" id="title" name="title"
                                   placeholder="Web Challenge Name">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Challenge Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Description of the challenge, hints, or context..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="flag_format" class="form-label">Flag Format</label>
                            <input type="text" class="form-control" id="flag_format" name="flag_format"
                                   placeholder="CTF{...} or flag{...}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="hint" class="form-label">Hint (Optional)</label>
                            <input type="text" class="form-control" id="hint" name="hint"
                                   placeholder="Any additional hints...">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="source_code" class="form-label">Source Code (Optional)</label>
                        <textarea class="form-control font-monospace" id="source_code" name="source_code" rows="8"
                                  placeholder="Paste source code here if available..."></textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-md-2" onclick="clearForm()">
                            <i class="fas fa-times me-1"></i>Clear
                        </button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <i class="fas fa-rocket me-1"></i>Start Solving
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Info Panel -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How It Works</h5>
            </div>
            <div class="card-body">
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <span class="badge bg-primary rounded-pill">1</span>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6>Web Crawling</h6>
                        <small class="text-muted">AI agent maps the web application structure</small>
                    </div>
                </div>
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <span class="badge bg-primary rounded-pill">2</span>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6>Content Analysis</h6>
                        <small class="text-muted">Analyzes source code and web content</small>
                    </div>
                </div>
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <span class="badge bg-primary rounded-pill">3</span>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6>Threat Modeling</h6>
                        <small class="text-muted">Identifies vulnerabilities and attack vectors</small>
                    </div>
                </div>
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <span class="badge bg-primary rounded-pill">4</span>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6>Smart Fuzzing</h6>
                        <small class="text-muted">Exploits vulnerabilities to find flags</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Challenges -->
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activity</h5>
            </div>
            <div class="card-body" id="recent-activity">
                <p class="text-muted mb-0">No recent challenges</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('challenge-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(e.target);
        const challengeData = {
            url: formData.get('url'),
            title: formData.get('title'),
            description: formData.get('description'),
            source_code: formData.get('source_code') || null,
            flag_format: formData.get('flag_format'),
            hint: formData.get('hint') || null
        };
        
        const response = await fetch('/api/challenges/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(challengeData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Challenge submitted successfully! Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = `/challenges/${result.challenge_id}`;
            }, 1500);
        } else {
            showToast(result.message || 'Submission failed', 'danger');
        }
        
    } catch (error) {
        console.error('Submission error:', error);
        showToast('Network error occurred', 'danger');
    } finally {
        // Restore button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

function clearForm() {
    document.getElementById('challenge-form').reset();
}

// Load recent activity
async function loadRecentActivity() {
    try {
        const response = await fetch('/api/challenges');
        const data = await response.json();
        
        const container = document.getElementById('recent-activity');
        
        if (data.challenges && data.challenges.length > 0) {
            container.innerHTML = data.challenges
                .slice(0, 5)
                .map(challenge => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <small class="fw-bold">${challenge.title || 'Untitled'}</small><br>
                            <small class="text-muted">${challenge.status}</small>
                        </div>
                        <span class="badge bg-${challenge.flags_found > 0 ? 'success' : 'primary'}">
                            ${challenge.flags_found > 0 ? 'Solved' : 'Running'}
                        </span>
                    </div>
                `).join('');
        } else {
            container.innerHTML = '<p class="text-muted mb-0">No recent challenges</p>';
        }
    } catch (error) {
        console.error('Failed to load recent activity:', error);
    }
}

// Load recent activity on page load
document.addEventListener('DOMContentLoaded', loadRecentActivity);
</script>
{% endblock %}